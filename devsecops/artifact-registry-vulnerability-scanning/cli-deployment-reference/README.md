# To manually trigger deployent in a non-safe-inputs GCP project

## Set up env variables

Authorize project login, modify variables below (these are for lilakcc project - to be deleted):

```
export BRANCH_NAME=main
export PROJECT_ID=phx-01jcqzx71nn
export PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format="value(projectNumber)")
export BUCKET_NAME=phx-01jcqzx71nn1-bucket-of-risk
export VULN_CLOUD_FUNCTION_SERVICE_ACCOUNT=phx-01jcqzx71nn-vuln-gcf
export REPO_NAME=phx-01jcqzx71nn-repo-of-risk
export REGION=northamerica-northeast1
```

## Run script to provision resources and deploy cloud function

```
./init.sh
```

## Or instead deploy with Cloud Build

Comment out the deployment / push image protion in init.sh (below the dashed line), then deploy:

```
gcloud builds submit --config ./devsecops/artifact-registry-vulnerability-scanning/cloudbuild.yaml --substitutions=_BRANCH_NAME=$BRANCH_NAME,_BUCKET_NAME=$BUCKET_NAME,_VULN_CLOUD_FUNCTION_SERVICE_ACCOUNT=$VULN_CLOUD_FUNCTION_SERVICE_ACCOUNT,_PROJECT_ID=$PROJECT_ID

```

### Push a test image with vunerabilities to Artifact Registry to see bucket output

If Artifact Registry repository does not yet exists:

```
gcloud artifacts repositories create $REPO_NAME \
 --location=northamerica-northeast1 \
 --repository-format=docker  \
 --project=$PROJECT_ID
```

Then pull and push image:

```
gcloud auth configure-docker northamerica-northeast1-docker.pkg.dev
docker pull nginx
docker tag nginx northamerica-northeast1-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/nginx67
docker push northamerica-northeast1-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/nginx67
```

#### To get list of severities of an image (not used in function):

```
gcloud artifacts docker images list --show-occurrences \
northamerica-northeast1-docker.pkg.dev/phx-01jcqzx71nn/phx-01jcqzx71nn-repo-of-risk/nginxsa3a23
```

#### To get all vunerabilities for an image and save to file:

```
gcloud artifacts docker images list --show-occurrences \
--occurrence-filter='kind="VULNERABILITY"' --format=json \
northamerica-northeast1-docker.pkg.dev/phx-01jcqzx71nn/phx-01jcqzx71nn-repo-of-risk/nginxsa3a23 > vunerabilities.json
```
