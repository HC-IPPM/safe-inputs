steps:
  - id: deploy-cloud-function-if-main
    name: 'gcr.io/google.com/cloudsdktool/cloud-sdk@sha256:e0246385c6f43e997bb49541de7c684846ee9c2baa738a68613f14cab987feb8'
    dir: devsecops/artifact-registry-vulnerability-scanning/
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud functions deploy imageVulnPubSubHandler \
          --gen2 \
          --source=./cloud-function \
          --runtime=nodejs18 \
          --trigger-topic=container-analysis-occurrences-v1 \
          --entry-point=imageVulnPubSubHandler \
          --set-env-vars=BUCKET_NAME=${_BUCKET_NAME} \
          --region=northamerica-northeast1 \
          --build-service-account=projects/phx-01j1tbke0ax/serviceAccounts/phx-01j1tbke0ax-cloudbuild@phx-01j1tbke0ax.iam.gserviceaccount.com \
          --service-account=phx-01j1tbke0ax-vuln-gcf@phx-01j1tbke0ax.iam.gserviceaccount.com \
          --docker-repository=northamerica-northeast1-docker.pkg.dev/phx-01j1tbke0ax/phx-01j1tbke0ax-vuln-cloudfunction

substitutions:
  _BUCKET_NAME: safe-inputs-devsecops-outputs-for-dashboard

options:
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET
