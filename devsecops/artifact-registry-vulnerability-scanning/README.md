# Artifact Registry Vunerability Scanning - Saving to Bucket

Google Cloud Platform (GCP) automatically scans container images stored in the Artifact Registry for vulnerabilities [multiple times a day](https://cloud.google.com/artifact-analysis/docs/container-scanning-overview). To view these vunerabilities external to GCP via dashboard, we're saving these in a Cloud Storage Bucket.

We've based this feature on this [tutorial](https://medium.com/google-cloud/centrally-managing-artifact-registry-container-image-vulnerabilities-on-google-cloud-part-one-d86fb4791601), which involves collecting occurrences published by the Artifact Registry (e.g., discovery, package, or vulnerability), filtering for vulnerabilities, and uploading the results to a Cloud Storage bucket. The destination filename for each vunerability is a concatenation of the vulnerability ID, package name and version, image name, and SHA.

<figure>
  <img src="../diagrams/vuln-scanning-artifact-registry.svg" 
       alt="Pub/Sub picks up occurrences from continuously scanned Artifact Registry. The Cloud Function, which is subscribed to the Pub/Sub occurrence topic, filters and processes these occurrences and saves them to a Google Cloud Storage bucket." 
       width="450" />
  <figcaption>
    Diagram: Saving automatic Artifact Registry vunerability scan outputs to cloud storage.
  </figcaption>
</figure>

## Set up

The resources are provisioned with Config Controller via IaC in the [acm-core ](https://github.com/PHACDataHub/acm-core/tree/main/DMIA-PHAC/Experimentation/ph-safeinputs) GitHub repository.

To set up without Config Contoller, gcloud commands can be found in the [cli-deployment-reference](./cli-deployment-reference/init.sh) directory, although the plan is to remove this once the IaC is solidified.

## Items To Revisit

- Review and file naming conventions and formatting once we have a better idea of how they will be used with the dashboard.
- [Cloud Functions are now part of Cloud Run](https://cloud.google.com/blog/products/serverless/google-cloud-functions-is-now-cloud-run-functions?_gl=1*5tvv8f*_ga*MzIwMDg1MDAyLjE3MTQ3Njc0NzE.*_ga_WH2QY8WWF5*MTcyOTYwOTIwOC4yNTIuMS4xNzI5NjA5NDEyLjU5LjAuMA..) and anticipate deployment scripts will need to be modified as they further converge in the future.

## Additonal Resources

- https://cloud.google.com/run/docs/tutorials/eventarc-functions
- https://cloud.google.com/artifact-analysis/docs/investigate-vulnerabilities
- https://cloud.google.com/artifact-analysis/docs/container-scanning-overview
- https://medium.com/@a.j.abbott24/google-cloud-surfacing-container-image-vulnerabilities-91dcf3f147f3

## Additional Considerations

- Containerization is handled by Cloud Run Functions at this time.
- Both the bucket retention policy where the vunerability outputs are being stored and the Artifact Registry's max age on which scanning will occur is 30 days. This is something to make note of on the dashboard - this feature will only be accessible for projects actively being updated and not on pause for more than a month.
