# Artifact Registry Vunerability Scanning

Google Cloud Platform (GCP) continuously scans container images stored in the Artifact Registry for vulnerabilities. More details can be found in the Google documentation. We've based this feature on this [tutorial](https://medium.com/google-cloud/centrally-managing-artifact-registry-container-image-vulnerabilities-on-google-cloud-part-one-d86fb4791601) and involves collecting occurrences (e.g., discovery, package, or vulnerability), filtering for vulnerabilities, and uploading the results to a Cloud Storage bucket. Each file name includes the vulnerability ID, image name, and SHA, and are to be used for the cATO dashboard.

## To Revisit
* Review and file naming conventions and formatting when we have a better idea of how they will be used with the dashboard.
* The bucket retention policy is currently set to 30 days, however, vunerability scanning only applies to artifacts less than 30 days old; metadata is archived by Artifact Registry.  Something to make note of for projects projects on hold. 
* This will likely need to be updated in the near future as [Cloud Functions are now part of Cloud Run](https://cloud.google.com/blog/products/serverless/google-cloud-functions-is-now-cloud-run-functions?_gl=1*5tvv8f*_ga*MzIwMDg1MDAyLjE3MTQ3Njc0NzE.*_ga_WH2QY8WWF5*MTcyOTYwOTIwOC4yNTIuMS4xNzI5NjA5NDEyLjU5LjAuMA..) and anticipate deployment scripts to become more streamlined.
* The service account used to create the project namespace is hardcoded as it's in the setters.yaml file.
* Need to set up a cloudbuild trigger (in acm-core) to deploy new changes to the cloud function.
* Need some sort of testing.

## File outputs from Continuous Vulnerability Scanning in Artifact Registry

![Artifact Registry Vulnerability Scanning Architecture Diagram](../diagrams/vuln-scanning-artifact-registry.svg)

## Set up

The resources for this feature will be provisioned in the [acm-core IaC GitHub repository](https://github.com/PHACDataHub/acm-core/). The [init.sh](init.sh) file was used to *gcloud* the resources and permissions into place and will be removed once the IaC is solidified. 

## Deploy the Cloud Function

The Cloud Function for vunerability filtering is not initially containerized within GitHub, as it uses Cloud Run Functions for containerization. The resulting image is stored in the gcf-artifacts repository in the Artifact Registry, and any updates to the function will be deployed using Cloud Build from GitHub.

### To manually trigger deployent with Cloud Build

```
export BRANCH_NAME=main
gcloud builds submit --config ./cloudbuild.yaml --substitutions=BRANCH_NAME=$BRANCH_NAME,COMMIT_SHA=runOutSideOfGitTrigger-$COMMIT_SHA
```


## Additonal Resources

* https://cloud.google.com/run/docs/tutorials/eventarc-functions
* https://cloud.google.com/artifact-analysis/docs/investigate-vulnerabilities
* https://medium.com/@a.j.abbott24/google-cloud-surfacing-container-image-vulnerabilities-91dcf3f147f3


## Additional Considerations

\* NOTE - Cloud Functions uses common js, and have modified .eslintrc to accomadoate. 
