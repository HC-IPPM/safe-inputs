# Artifact Registry Vunerability Scanning

Google Cloud Platform (GCP) continuously scans container images stored in Artifact Registry for vulnerabilities. More details can be found in the Google documentation. We've based this feature on this [tutorial](https://medium.com/google-cloud/centrally-managing-artifact-registry-container-image-vulnerabilities-on-google-cloud-part-one-d86fb4791601) and involves collecting occurrences (e.g., discovery, package, or vulnerability), filtering for vulnerabilities, and uploading the results to a Cloud Storage bucket. Each file name includes the vulnerability ID, image name, and SHA, and are to be used for the cATO dashboard.

<figure>
  <img src="../diagrams/vuln-scanning-artifact-registry.svg" 
       alt="Pub/Sub picks up occurrences from continuously scanned Artifact Registry. The Cloud Function, which is subscribed to the Pub/Sub occurrence topic, filters and processes these occurrences and saves them to a Google Cloud Storage bucket." 
       width="450" />
  <figcaption>
    Diagram: Accessing outputs from Continuous Vulnerability Scanning in Artifact Registry.
  </figcaption>
</figure>

## Items To Revisit

- Review and file naming conventions and formatting when we have a better idea of how they will be used with the dashboard.
- The bucket retention policy where the vunerability outputs are being stored is currently set to 30 days, but in a addition, the vunerability scanning in Artifact Registry is only performed on artifacts younger than 30 days; after which the metadata is archived. This is something to make note as this will only be accessible for projectts actively being developed and not on pause for more than a month.

- [Cloud Functions are now part of Cloud Run](https://cloud.google.com/blog/products/serverless/google-cloud-functions-is-now-cloud-run-functions?_gl=1*5tvv8f*_ga*MzIwMDg1MDAyLjE3MTQ3Njc0NzE.*_ga_WH2QY8WWF5*MTcyOTYwOTIwOC4yNTIuMS4xNzI5NjA5NDEyLjU5LjAuMA..) and anticipate deployment scripts will need to be modified as they become more streamlined.
- The service account used to create the project namespace is hardcoded as it's in the setters.yaml file.
- Need to set up a cloudbuild trigger (in acm-core) to deploy new changes to the cloud function.
- Need some sort of testing.

## Set up

The resources for this feature will be provisioned in the [acm-core IaC GitHub repository](https://github.com/PHACDataHub/acm-core/). The [init.sh](./gcloud-equivalent/init.sh) file was used to _gcloud_ the resources and permissions into place and will be removed once the IaC is solidified.

## Deploy the Cloud Function

The Cloud Function for vunerability filtering is not initially containerized within GitHub as this is done with Cloud Run Functions. The resulting image is stored in the gcf-artifacts repository in the Artifact Registry, which is also scanned for vunerabilities. Any updates to the function will be deployed using Cloud Build triggered by changes to source code in GitHub.

### To manually trigger deployent with gcloud/Cloud Build

See [gcloud-equivalent](./gcloud-equivalent/) directory.

## Additonal Resources

- https://cloud.google.com/run/docs/tutorials/eventarc-functions
- https://cloud.google.com/artifact-analysis/docs/investigate-vulnerabilities
- https://medium.com/@a.j.abbott24/google-cloud-surfacing-container-image-vulnerabilities-91dcf3f147f3
- To test using pub/sub emulator https://cloud.google.com/functions/docs/local-development

## Additional Considerations

- NOTE - Cloud Functions uses common js, and have modified .eslintrc to accomadoate.
